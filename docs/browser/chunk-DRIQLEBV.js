import{d}from"./chunk-EV7PFGVU.js";import{J as m,N as o,Qb as p,Rb as h,Y as i,mb as s}from"./chunk-IKTNIUHG.js";var u=class n{supabase=o(p);auth=o(h);loading=i(!1);expenses=i([]);groupedDailyTotals=s(()=>{let e=new Map;for(let t of this.expenses())t.archived||e.set(t.date,(e.get(t.date)??0)+t.amount);return Array.from(e.entries()).map(([t,r])=>({date:t,total:r})).sort((t,r)=>r.date.localeCompare(t.date))});async refresh(){this.loading.set(!0);try{let e=this.auth.currentUser()?.id;if(!e){this.expenses.set([]);return}let{data:t,error:r}=await this.supabase.client.from("expenses").select("*").eq("user_id",e).order("date",{ascending:!1}).order("time",{ascending:!1});if(r)throw r;this.expenses.set(t||[])}finally{this.loading.set(!1)}}async getById(e){let{data:t,error:r}=await this.supabase.client.from("expenses").select("*").eq("id",e).single();if(r)throw r;return t}expensesByDate(e){return s(()=>this.expenses().filter(t=>t.date===e&&!t.archived).slice().sort((t,r)=>t.time.localeCompare(r.time)))}totalByDate(e){return s(()=>this.expensesByDate(e)().reduce((t,r)=>t+r.amount,0))}async add(e){let t=this.auth.currentUser()?.id;if(!t)throw new Error("User not authenticated");let r=new Date,a={id:crypto.randomUUID(),amount:e.amount,category:e.category,description:e.description,date:e.date,time:e.time,paymentMethod:e.paymentMethod,archived:!1,createdAt:r.toISOString(),updatedAt:r.toISOString()},{data:f,error:c}=await this.supabase.client.from("expenses").insert({user_id:t,amount:a.amount,category:a.category,description:a.description,date:a.date,time:a.time,payment_method:a.paymentMethod,archived:!1}).select().single();if(c)throw c;return await this.refresh(),f}async update(e){let t=this.auth.currentUser()?.id;if(!t)throw new Error("User not authenticated");let{data:r,error:a}=await this.supabase.client.from("expenses").update({amount:e.amount,category:e.category,description:e.description,date:e.date,time:e.time,payment_method:e.paymentMethod,archived:e.archived}).eq("id",e.id).eq("user_id",t).select().single();if(a)throw a;return await this.refresh(),r}async remove(e){let t=this.auth.currentUser()?.id;if(!t)throw new Error("User not authenticated");let{error:r}=await this.supabase.client.from("expenses").delete().eq("id",e).eq("user_id",t);if(r)throw r;await this.refresh()}async archive(e){await this.update({id:e,archived:!0})}createDefaultsForNow(e){let t=new Date;return{amount:e?.amount??0,category:e?.category??"\u0623\u062E\u0631\u0649",description:e?.description??"",date:e?.date??d(t,"yyyy-MM-dd"),time:e?.time??d(t,"HH:mm"),paymentMethod:e?.paymentMethod??"cash"}}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{u as a};
